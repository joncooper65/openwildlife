/*! open-wildlife 2015-05-29 */
require.config({paths:{jquery:"../vendor/jquery/jquery.min",jquerymobile:"../vendor/jquery-mobile-bower/js/jquery.mobile-1.4.2.min",leaflet:"../vendor/leaflet/dist/leaflet",underscore:"../vendor/underscore/underscore-min",Chart:"../vendor/Chart.js/Chart.min"}}),require(["jquery","jquerymobile","leaflet","underscore","Chart"],function(a,b,c,d,e){function f(a){var b=[];return d.map(a,function(a){b.push(a)}),b}function g(a,b){var c=d.findWhere(b,{taxonKey:a.taxonKey});d.isUndefined(c)?b.push(h(a)):(d.contains(c.datasetKeys,a.datasetKey)||c.datasetKeys.push(a.datasetKey),c.latestYear<a.year&&(c.latestYear=a.year),c.earliestYear>a.year&&(c.earliestYear=a.year),c.numRecs+=1)}function h(a){var b={taxonKey:a.taxonKey,name:k(a.species),earliestYear:a.year,latestYear:a.year,datasetKeys:[],numRecs:1};return b.datasetKeys.push(a.datasetKey),b}function i(b,c,e){var f=[];d.each(c,function(a){f.push(l(a.taxonKey))}),a.when.apply(a,f).done(function(){var g=[],h=[];d.each(f,function(a){d.each(c,function(b){var c=b.taxonKey==a.responseJSON.speciesKey;c&&(d.isUndefined(a.responseJSON.vernacularName)||(b.vernacularName=k(a.responseJSON.vernacularName)))})}),g=d.chain(c).filter(function(a){return!d.isUndefined(a.vernacularName)}).sortBy("vernacularName").value(),h=d.chain(c).filter(function(a){return d.isUndefined(a.vernacularName)}).sortBy("name").value();var i='<div class="popup-content"><ul data-role="listview">';d.each(g,function(a){i+=j(a,!1)}),d.isEmpty(h)||(d.isEmpty(g)||(i+='<li class="popup-heading"><h4>No common name:</h4></li>'),d.each(h,function(a){i+=j(a,!1)})),i+="</ul></div>",b.setContent(i),a("#index").enhanceWithin(),e()})}function j(a,b){var c="<i>"+a.name+"</i>";return b||d.isUndefined(a.vernacularName)||(c=a.vernacularName),'<li><a class="popup-link" href="#species-info-page?datasetKeys='+a.datasetKeys.join(",")+"&taxonKey="+a.taxonKey+"&earliest="+a.earliestYear+"&latest="+a.latestYear+'">'+c+"</a></li>"}function k(a){return a.charAt(0).toUpperCase()+a.toLowerCase().slice(1)}function l(b){var c="http://api.gbif.org/v1/species/"+b;return a.ajax({type:"GET",url:c,async:!0,contentType:"application/json",dataType:"jsonp",error:function(b){a.mobile.loading("hide"),console.log(b.getResponseHeader())},statusCode:{503:function(){console.log("gbif service failed to respond")}}})}function m(a){var b='<div class="popup-content"><ul data-role="listview">';return a.properties&&a.properties.species&&d.each(a.properties.species,function(a){b+=j(a,!0)}),b+="</ul></div>"}function n(a){var b=a.getBounds();return""+b.getNorth()+b.getSouth()+b.getEast()+b.getWest()}function o(a){return 11>a?2:a>10&&21>a?3:a>20&&31>a?4:5}function p(b,c){var e=[],f="";d.each(b.split(","),function(a){e.push(s(a))});var g=[];a.when.apply(a,e).done(function(){d.each(e,function(a){var b={key:a.responseJSON.key,providerKey:a.responseJSON.publishingOrganizationKey,title:a.responseJSON.title,description:a.responseJSON.description,website:a.responseJSON.homepage};g.push(b)}),datasetsSorted=d.sortBy(g,"title"),f='<ul data-role="listview" data-inset="true">',d.each(datasetsSorted,function(a){f+='<li><a href="http://www.gbif.org/dataset/'+a.key+'" target="_new"><h2>'+a.title+"</h2></a></li>"}),f+="</ul>",a("#dataset-info",c.toPage).html(f),a("#species-info-page").enhanceWithin()})}function q(b,c,e){var f=l(b.taxonKey);f.done(function(){var g=f.responseJSON.species,h=f.responseJSON.vernacularName,i="<i>"+g+"</i>",j=i;d.isUndefined(h)||(i+=" ("+h.toLowerCase()+")"),e||d.isUndefined(h)||(j=h),a("#species-name-title",c.toPage).html(i),a("#species-name-intro",c.toPage).html(j),a("#species-info-date",c.toPage).html(r(b)),a("#species-info-page").enhanceWithin()})}function r(a){return a.earliestYear==a.latestYear?"Year observed: "+a.earliest:"Earliest observation: "+a.earliest+", latest observation: "+a.latest}function s(b){var c="http://api.gbif.org/v1/dataset/"+b;return a.ajax({type:"GET",url:c,async:!0,contentType:"application/json",dataType:"jsonp",error:function(b){a.mobile.loading("hide"),console.log(b.getResponseHeader())},statusCode:{503:function(){console.log("gbif service failed to respond")}}})}function t(a){return d.chain(a.split("?")[1].split("&")).map(function(a){var b=a.split("=");return[b[0],decodeURIComponent(b[1])]}).object().value()}function u(){return w()?(d.isEmpty(localStorage.isScientificNamePref)&&(localStorage.isScientificNamePref=!0),"true"===localStorage.isScientificNamePref):isScientificNamePref}function v(a){w()?localStorage.isScientificNamePref=a:isScientificNamePref=a}function w(){var a="test";try{return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(b){return!1}}function x(){a(".ui-navbar a").removeClass("ui-btn-active"),a("#index").enhanceWithin()}function y(b,c,e){summaryData.loadingGroups=!0,summaryData.loadingDatasets=!0,a("#summary-datasets").empty(),a("#species-group-summary > tbody").empty(),a("#top-ten-species > tbody").empty(),a("#summary-num-markers").html(Object.keys(b).length),a("#summary-num-recs").html(c),a("#summary-percentage-recs").html(e);var f=new Object,g=new Object,h=[],i=[],j=3e3,k=0;d.each(b,function(a){d.each(a.properties.species,function(a){a.earliestYear<j&&(j=a.earliestYear),a.latestYear>k&&(k=a.latestYear),f.hasOwnProperty(a.taxonKey)?(f[a.taxonKey].numRecs+=1,f[a.taxonKey].latestYear<a.latestYear&&(f[a.taxonKey].latestYear=a.latestYear),f[a.taxonKey].earliestYear>a.earliestYear&&(f[a.taxonKey].earliestYear=a.earliestYear)):(f[a.taxonKey]={taxonKey:a.taxonKey,name:a.name,earliestYear:a.earliestYear,latestYear:a.latestYear,numRecs:a.numRecs},i.push(l(a.taxonKey))),d.each(a.datasetKeys,function(a){var b=d.findWhere(h,{datasetKey:a});d.isUndefined(b)&&h.push({key:a})})})}),a("#summary-earliest-rec").html(j),a("#summary-latest-rec").html(k),a("#summary-num-species").html(Object.keys(f).length),A(h,!0),z(f),a.when.apply(a,i).done(function(){d.each(i,function(a){g.hasOwnProperty(a.responseJSON.classKey)?(g[a.responseJSON.classKey].numSpecies+=1,g[a.responseJSON.classKey].numRecs+=f[a.responseJSON.key].numRecs):g[a.responseJSON.classKey]={key:a.responseJSON.classKey,kingdomKey:a.responseJSON.kingdomKey,name:a.responseJSON["class"],numSpecies:1,numRecs:f[a.responseJSON.key].numRecs}});var a=[];d.each(g,function(b){a.push(b)});var b=d.sortBy(a,function(a){return-1*a.numRecs});if(!u()){var c=B(b),e=[];d.each(c,function(a){e.push(a)}),b=d.sortBy(e,function(a){return-1*a.numRecs})}D(b),summaryData.loadingGroups=!1,summaryData.isLoading()||document.body.dispatchEvent(new CustomEvent("summarygenerated"))})}function z(b){var c=[];d.each(b,function(a){c.push(a)});var e=d.sortBy(c,function(a){return-1*a.numRecs}).slice(0,10),f="Top 10 species";if(e.length<10&&(f="All species"),a("#summary-species-title").html(f),u())E(e);else{var g=[];d.each(e,function(a){g.push(l(a.taxonKey))}),a.when.apply(a,g).done(function(){d.each(g,function(a){d.each(e,function(b){var c=b.taxonKey==a.responseJSON.speciesKey;c&&(d.isUndefined(a.responseJSON.vernacularName)||(b.vernacularName=a.responseJSON.vernacularName))})}),E(e)})}}function A(b,c){var e=[];d.each(b,function(a){e.push(s(a.key))}),a.when.apply(a,e).done(function(){d.each(e,function(a){d.findWhere(b,{key:a.responseJSON.key}).title=a.responseJSON.title});var c=d.chain(b).filter(function(a){return a.hasOwnProperty("title")}).sortBy("title").value(),f='<ul  class="datasets" data-role="listview" data-inset="true">';d.each(c,function(a){f+='<li><a href="http://www.gbif.org/dataset/'+a.key+'" target="_new">'+a.title+"</a></li>"}),f+="</ul>",a("#summary-datasets").html(f),a("#summary-datasets").enhanceWithin(),summaryData.loadingDatasets=!1,summaryData.isLoading()||document.body.dispatchEvent(new CustomEvent("summarygenerated"))})}function B(a){var b={};return d.each(a,function(a){var c=C(a.key);null===c&&(c=C(a.kingdomKey)),null===c&&(c={key:a.key,value:a.name}),b.hasOwnProperty(c.key)?(b[c.key].numSpecies+=a.numSpecies,b[c.key].numRecs+=a.numRecs):b[c.key]={key:c.key,name:c.value,numSpecies:a.numSpecies,numRecs:a.numRecs}}),b}function C(a){var b=null;return d.each(F,function(c){d.each(c.key.split(","),function(d){a==d&&(b=c)})}),b}function D(b){var c=a("#species-group-summary > tbody");d.each(b,function(b){c.append(a("<tr>").append(a("<td>").text(b.name),a("<td>").text(b.numSpecies),a("<td>").text(b.numRecs)))}),a("#summary").enhanceWithin(),console.log(b)}function E(b){var c=a("#top-ten-species > tbody");d.each(b,function(b){var e="<i>"+b.name+"</i>";u()||d.isUndefined(b.vernacularName)||(e=b.vernacularName),c.append(a("<tr>").append(a("<td>").html(e),a("<td>").text(b.numRecs)))}),a("#summary").enhanceWithin()}a(document).ready(function(){function b(){r(),j()}function j(){var a=c.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:1,maxZoom:17,attribution:"Map data copyright <a href='http://openstreetmap.org'>OpenStreetMap</a> contributors"});J=c.map("map",{dragging:!0,touchZoom:!0,tap:!1,inertia:!0,inertiaDeceleration:3e3,inertiaMaxSpeed:1500,tap:!0,layers:[a]}),J.on("locationfound",function(a){U=!1,J.setView([a.latitude,a.longitude],15),W=!1}),J.on("locationerror",function(a){(2==a.code||1==a.code)&&(U=!0,k()),3!=a.code||U||k(),W=!1}),J.on("moveend",function(a){S||w(!1)}),J.locate({timeout:V})}function k(){var b=l();W?a("#welcome-message").show():a("#welcome-message").hide(),a("#random-reserve-name").html(b.name),a("#no-location-popup").popup("open"),J.setView([b.lat,b.lon],b.zoom)}function l(){var a=[{name:"Monks Wood",lat:52.406,lon:-.238,zoom:14},{name:"Barton Hills",lat:51.956,lon:-.421,zoom:15},{name:"The Lizard",lat:49.958,lon:-5.206,zoom:14},{name:"Cliburn Moss",lat:54.624,lon:-2.656,zoom:15},{name:"Buster Hill",lat:50.978,lon:-.981,zoom:15},{name:"Kinder Scout",lat:53.385,lon:-1.875,zoom:14},{name:"Holton Heath",lat:50.72,lon:-2.073,zoom:15},{name:"Foxley Wood",lat:52.762,lon:1.043,zoom:14},{name:"Weeting Heath",lat:52.461,lon:.587,zoom:15},{name:"Langley Wood",lat:52.101,lon:.842,zoom:16},{name:"Aberbargoed Grasslands",lat:51.685,lon:-3.213,zoom:15}];return a[Math.floor(Math.random()*a.length)]}function r(){function b(){N=a("#slider-year").val(),4!==N.length||S||(E(),w(!1))}a("#flip-name").flipswitch({create:function(b,c){u()?a("#flip-name").prop("checked",!0).flipswitch("refresh"):a("#flip-name").prop("checked",!1).flipswitch("refresh")}}),a("#flip-name").change(function(){v(a(this).is(":checked"))}),a("#slider-year").parent().touchend(b),a("#slider-year").parent().mouseup(b),a("#slider-year").parent().keyup(b),a("#taxon-group").change(function(){O=a("#taxon-group").val(),E(),w(!1)}),a("#add-more-records").click(function(b){R>=P?a("#no-more-records-popup").popup("open"):S||(w(!0),R+=Q)}),a(document).on("pagecontainerbeforetransition",function(b,c){if("undefined"!==a.type(c.toPage)&&"undefined"!==a.type(c.absUrl)&&"species-info-page"==c.toPage[0].id){var d=t(c.absUrl);p(d.datasetKeys,c),q(d,c,u())}}),a("#geolocate-button").click(function(){W=!1,J.locate({timeout:V})}),a("#summary-button").click(function(){y(T,z(P),A(P))}),a(document).on("pagecontainershow",function(b,c){var d=a("body").pagecontainer("getActivePage").prop("id");"summary"==d&&summaryData.isLoading()&&a.mobile.loading("show",{textVisible:!0,text:"Generating summary"})}),a(document.body).on("summarygenerated",function(b){a.mobile.loading("hide")})}function s(){var b="#252525";a(".leaflet-popup-content-wrapper").css("background-color",b),a(".leaflet-popup-tip").css("background",b),a(".leaflet-popup-content").css({"border-color":b}),a(".ui-content .ui-listview, .ui-panel-inner>.ui-listview").css("margin","0em 0em -1em -1em")}function w(b){if(K=n(J),L=N,!M){B(),S=!0;var d=C(b);a.ajax({type:"GET",url:d,contentType:"application/json",dataType:"jsonp",timeout:2e4,success:function(d){P=d.count,b||E(),I(d.results),c.geoJson(f(T),{onEachFeature:H,pointToLayer:function(a,b){var d=c.icon({iconUrl:"images/marker-icon-green-"+o(a.properties.species.length)+".png"});return c.marker(b,{icon:d})}}).addTo(J),a.mobile.loading("hide"),a("#add-more-records").text(z(P)),a("#summary-total-recs").html(P)},error:function(b,c,d){S=!1,a.mobile.loading("hide")},complete:function(b){S=!1,a.mobile.loading("hide"),x(),K!==n(J)&&w(!1),L!==a("#slider-year").val()&&w(!1)}})}}function z(a){return R>a?a+" of "+a:R+" of "+a}function A(a){return R>a?100:Math.round(R/a*100)}function B(){a.mobile.loading("show",{defaults:!0})}function C(a){var b=J.getBounds();return"http://api.gbif.org/v1/occurrence/search?decimalLongitude="+b.getWest()+","+b.getEast()+"&decimalLatitude="+b.getSouth()+","+b.getNorth()+"&hasCoordinate=true"+(1900!=N?"&year="+N+","+(new Date).getFullYear():"")+D()+"&limit="+Q+(a?"&offset="+R:"")}function D(){var a="&taxonKey=";if(d.isNumber(O))return a+O;if(d.isUndefined(O)||d.isEmpty(O))return"";var b="";return d.each(O.split(","),function(c){b+=a+c}),b}function E(){R=Q,T={},J.eachLayer(function(a){try{d.isUndefined(a.feature.properties.species)||J.removeLayer(a)}catch(b){}})}function F(b){M=!0,b.popup.setContent('<span class="popup-heading">Getting species...</span>'),u()?(b.popup.setContent(m(b.target.feature)),a("#index").enhanceWithin()):i(b.popup,b.target.feature.properties.species,s),s()}function G(a){M=!1}function H(a,b){var d=c.popup({maxWidth:250,minWidth:200,maxHeight:200,autoPan:!0,keepInView:!0},b);b.bindPopup(d,{className:"map-popup"}),b.on("popupopen",F),b.on("popupclose",G)}function I(a){var b=4;d.each(a,function(a){if(a.hasOwnProperty("species")){var c=a.decimalLongitude.toFixed(b)+a.decimalLongitude.toFixed(b);T.hasOwnProperty(c)?g(a,T[c].properties.species):(T[c]={type:"Feature",geometry:{type:"Point",coordinates:[a.decimalLongitude.toFixed(b),a.decimalLatitude.toFixed(b)]},properties:{species:[]}},T[c].properties.species.push(h(a)))}}),d.each(T,function(a){a.properties.species=d.sortBy(a.properties.species,"name")})}var J,K,L,M=!1,N=String(1900),O="",P=0,Q=300,R=Q,S=!1,T={},U=!1,V=5e3,W=!0;e.noConflict();summaryData={loadingDatasets:!1,loadingGroups:!1,isLoading:function(){return this.loadingDatasets||this.loadingGroups}},b()});var F=[{key:"131",value:"Amphibians"},{key:"797",value:"Butterflies and moths"},{key:"327,13,9,126,125",value:"Bryophytes"},{key:"212",value:"Birds"},{key:"1470",value:"Beetles"},{key:"194",value:"Conifers"},{key:"789",value:"Dragonflies and damselflies"},{key:"120,121,204,239,357",value:"Fishes"},{key:"220",value:"Flowering plants"},{key:"5",value:"Fungi"},{key:"1458",value:"Grasshoppers and crickets"},{key:"216",value:"Insects"},{key:"359",value:"Mammals"},{key:"52",value:"Molluscs"},{key:"715",value:"Reptiles"},{key:"1003,1225,787",value:"River flies"},{key:"225",value:"Slugs and snails"},{key:"1496",value:"Spiders"}]});